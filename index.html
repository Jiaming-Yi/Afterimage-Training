<!DOCTYPE html>
<!-- 更新时间: 2025-01-27 -->
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>残像训练程序 - 右脑开发基础训练</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .training-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
            max-width: 800px;
            width: 100%;
        }

        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            background: #667eea;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .mode-btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .mode-btn.active {
            background: #4c51bf;
            box-shadow: 0 4px 15px rgba(76, 81, 191, 0.4);
        }

        .training-area {
            text-align: center;
            min-height: 500px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 2px dashed #ddd;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 20px;
            position: relative;
        }

        .training-card {
            width: 200px;
            height: 200px;
            border-radius: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .training-card:hover {
            transform: scale(1.05);
        }

        /* 训练时填满整个训练区域 */
        .training-card.training-active {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 15px;
            margin: 0;
            z-index: 10;
        }
        
        .training-card.training-active.yellow-card::after {
            width: 8vmin;
            height: 8vmin;
        }

        /* 黄卡样式 */
        .yellow-card {
            background: #ffff00;
            position: relative;
        }

        .yellow-card::after {
            content: '';
            width: 40px;
            height: 40px;
            background: #0606f2;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* 白色背景 */
        .white-background {
            background: white;
            border: 2px solid #ccc;
        }

        /* 彩虹颜色卡片 */
        .color-red { background: #FF0000; }
        .color-orange { background: #FFA500; }
        .color-yellow { background: #FFFF00; }
        .color-green { background: #00FF00; }
        .color-cyan { background: #00FFFF; }
        .color-blue { background: #0000FF; }
        .color-purple { background: #800080; }

        /* 形状卡片 */
        .shape-card {
            background: white;
            border: 3px solid #333;
        }

        .circle {
            width: 80px;
            height: 80px;
            border: 4px solid #000;
            border-radius: 50%;
            background: transparent;
        }

        .triangle {
            width: 0;
            height: 0;
            border-left: 40px solid transparent;
            border-right: 40px solid transparent;
            border-bottom: 70px solid #000;
        }

        .diamond {
            width: 60px;
            height: 60px;
            background: transparent;
            border: 4px solid #000;
            transform: rotate(45deg);
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .start-btn {
            background: #667eea;
            color: white;
        }

        .start-btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .stop-btn {
            background: #6c757d;
            color: white;
        }

        .stop-btn:hover {
            background: #5a6268;
        }

        .switch-btn {
            background: #667eea;
            color: white;
        }

        .switch-btn:hover {
            background: #5a6fd8;
        }

        .next-btn {
            background: #667eea;
            color: white;
        }

        .next-btn:hover {
            background: #5a6fd8;
        }

        .log-btn {
            background: #805ad5;
            color: white;
        }

        .log-btn:hover {
            background: #6b46c1;
        }

        .timer {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .instructions {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #667eea;
        }

        .instructions h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .instructions ul {
            list-style-type: none;
            padding-left: 0;
        }

        .instructions li {
            margin: 8px 0;
            padding: 5px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .instructions li:last-child {
            border-bottom: none;
        }

        .color-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.active {
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
        }

        .shape-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .shape-option {
            padding: 10px 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .shape-option:hover {
            border-color: #667eea;
        }

        .shape-option.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.1s ease;
        }

        .training-settings {
            text-align: center;
            margin: 20px 0;
        }

        .training-settings label {
            font-weight: bold;
            color: #4a5568;
            margin-right: 10px;
        }

        .training-settings input {
            width: 80px;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #ccc;
            text-align: center;
            font-size: 1em;
        }

        .training-stats {
            display: flex;
            justify-content: space-around;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            border: 1px solid #e2e8f0;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            display: block;
            font-size: 14px;
            color: #718096;
            margin-bottom: 5px;
        }

        .stat-value {
            display: block;
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .log-entry {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .log-date {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .log-details {
            color: #718096;
            font-size: 14px;
        }

        .clear-log-btn {
            background: #6c757d;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .clear-log-btn:hover {
            background: #5a6268;
        }

        .pomodoro-timer {
            background: #f0f2f5;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .pomodoro-timer h3 {
            color: #dd6b20;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .pomodoro-display {
            font-size: 3em;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 20px;
        }

        .pomodoro-display .pomodoro-status {
            display: block;
            font-size: 0.4em;
            font-weight: normal;
            color: #718096;
            margin-bottom: 5px;
        }

        .pomodoro-display .pomodoro-status.break-mode {
            color: #38a169;
        }

        .pomodoro-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        #pomodoroStartPause {
            background-color: #38a169;
        }
        #pomodoroStartPause:hover {
            background-color: #2f855a;
        }
        
        #pomodoroReset {
            background-color: #718096;
        }
        #pomodoroReset:hover {
            background-color: #4a5568;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .training-container {
                padding: 20px;
            }
            
            .training-card {
                width: 150px;
                height: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🧠 残像训练程序</h1>
        <p>右脑开发基础训练 - 提升照相记忆能力</p>
    </div>

    <div class="training-container">
        <!-- 训练模式选择 -->
        <div class="mode-selector">
            <button class="mode-btn active" data-mode="yellow">黄卡训练</button>
            <button class="mode-btn" data-mode="color">彩虹颜色训练</button>
            <button class="mode-btn" data-mode="shape">形状训练</button>
        </div>

        <!-- 番茄钟 -->
        <div class="pomodoro-timer">
            <h3>🍅 番茄钟</h3>
            <div class="pomodoro-display">
                <span id="pomodoroStatus" class="pomodoro-status">专注</span>
                <span id="pomodoroTime">25:00</span>
            </div>
            <div class="pomodoro-controls">
                <button class="control-btn" id="pomodoroStartPause">开始</button>
                <button class="control-btn" id="pomodoroReset">重置</button>
            </div>
        </div>

        <!-- 训练区域 -->
        <div class="training-area" id="trainingArea">
            <div class="training-card yellow-card" id="trainingCard"></div>
        </div>

        <!-- 计时器 -->
        <div class="timer" id="timer">准备开始训练</div>

        <!-- 训练设置 -->
        <div class="training-settings">
            <label for="durationSetting">每阶段时长(秒):</label>
            <input type="number" id="durationSetting" value="30" min="5" max="300" step="5">
        </div>

        <!-- 进度条 -->
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <!-- 控制按钮 -->
        <div class="controls">
            <button class="control-btn start-btn" id="startBtn">开始训练</button>
            <button class="control-btn switch-btn" id="switchBtn" disabled>切换到白纸</button>
            <button class="control-btn stop-btn" id="stopBtn" disabled>停止训练</button>
            <button class="control-btn next-btn" id="nextBtn" style="display: none;">下一个</button>
            <button class="control-btn log-btn" id="logBtn">查看训练日志</button>
        </div>

        <!-- 训练统计 -->
        <div class="training-stats" id="trainingStats">
            <div class="stat-item">
                <span class="stat-label">当前轮次:</span>
                <span class="stat-value" id="currentRound">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">本次训练时间:</span>
                <span class="stat-value" id="sessionTime">0分0秒</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">累计训练时间:</span>
                <span class="stat-value" id="totalTime">0分钟</span>
            </div>
        </div>

        <!-- 彩虹颜色选择器 -->
        <div class="color-selector" id="colorSelector" style="display: none;">
            <div class="color-option color-red" data-color="red"></div>
            <div class="color-option color-orange" data-color="orange"></div>
            <div class="color-option color-yellow" data-color="yellow"></div>
            <div class="color-option color-green" data-color="green"></div>
            <div class="color-option color-cyan" data-color="cyan"></div>
            <div class="color-option color-blue" data-color="blue"></div>
            <div class="color-option color-purple" data-color="purple"></div>
        </div>

        <!-- 形状选择器 -->
        <div class="shape-selector" id="shapeSelector" style="display: none;">
            <div class="shape-option active" data-shape="circle">圆形 ○</div>
            <div class="shape-option" data-shape="triangle">三角形 △</div>
            <div class="shape-option" data-shape="diamond">菱形 ◇</div>
        </div>

        <!-- 训练说明 -->
        <div class="instructions" id="instructions">
            <h3>🎯 黄卡训练说明</h3>
            <ul>
                <li>1. 在上方设置好每阶段时长后，点击"开始训练"按钮</li>
                <li>2. 每轮训练：凝视黄卡【设定时长】 → 自动切换白纸【设定时长】 → 自动开始下一轮</li>
                <li>3. 训练过程中尽量不要眨眼，保持注意力集中</li>
                <li>4. 初期看到的残像是补色（蓝底黄点），随着训练进步会看到原色</li>
                <li>5. 程序会自动记录训练时间和轮次，可点击"停止训练"结束并保存记录</li>
            </ul>
        </div>
    </div>

    <!-- 训练日志模态框 -->
    <div id="logModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📊 训练日志</h2>
                <span class="close" id="closeModal">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px;">
                    <button class="clear-log-btn" id="clearLogBtn">清空日志</button>
                </div>
                <div id="logContent">
                    <p style="text-align: center; color: #718096;">暂无训练记录</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        class AfterimageTrainer {
            constructor() {
                this.currentMode = 'yellow';
                this.isTraining = false;
                this.timer = null;
                this.timeLeft = 0;
                this.totalTime = 30;
                this.currentColorIndex = 0;
                this.currentShape = 'circle';
                this.colors = ['red', 'orange', 'yellow', 'green', 'cyan', 'blue', 'purple'];
                this.colorNames = {
                    'red': '红色', 'orange': '橙色', 'yellow': '黄色', 
                    'green': '绿色', 'cyan': '青色', 'blue': '蓝色', 'purple': '紫色'
                };
                
                // 训练统计相关
                this.currentRound = 0;
                this.sessionStartTime = null;
                this.sessionTime = 0;
                this.autoTraining = false;
                this.sessionTimer = null;
                
                this.initializeElements();
                this.bindEvents();
                this.updateInstructions();
                this.loadTrainingStats();
                this.startSessionTimer();
            }

            initializeElements() {
                this.timerDisplay = document.getElementById('timer');
                this.progressFill = document.getElementById('progressFill');
                this.trainingArea = document.getElementById('trainingArea');
                this.trainingCard = document.getElementById('trainingCard');
                this.startBtn = document.getElementById('startBtn');
                this.switchBtn = document.getElementById('switchBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.nextBtn = document.getElementById('nextBtn');
                this.logBtn = document.getElementById('logBtn');
                this.colorSelector = document.getElementById('colorSelector');
                this.shapeSelector = document.getElementById('shapeSelector');
                this.instructions = document.getElementById('instructions');
                this.durationInput = document.getElementById('durationSetting');
                
                // 统计显示元素
                this.currentRoundDisplay = document.getElementById('currentRound');
                this.sessionTimeDisplay = document.getElementById('sessionTime');
                this.totalTimeDisplay = document.getElementById('totalTime');
                
                // 模态框元素
                this.logModal = document.getElementById('logModal');
                this.closeModal = document.getElementById('closeModal');
                this.clearLogBtn = document.getElementById('clearLogBtn');
                this.logContent = document.getElementById('logContent');
            }

            bindEvents() {
                // 模式选择按钮
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentMode = e.target.dataset.mode;
                        this.resetTraining();
                        this.setupMode();
                    });
                });

                // 控制按钮
                this.startBtn.addEventListener('click', () => this.startTraining());
                this.switchBtn.addEventListener('click', () => this.switchToWhite());
                this.stopBtn.addEventListener('click', () => this.stopTraining());
                this.nextBtn.addEventListener('click', () => this.nextItem());
                this.logBtn.addEventListener('click', () => this.showTrainingLog());

                // 颜色选择器
                document.querySelectorAll('.color-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        document.querySelectorAll('.color-option').forEach(o => o.classList.remove('active'));
                        e.target.classList.add('active');
                        this.setupColorCard(e.target.dataset.color);
                    });
                });

                // 形状选择器
                document.querySelectorAll('.shape-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        document.querySelectorAll('.shape-option').forEach(o => o.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentShape = e.target.dataset.shape;
                        this.setupShapeCard(this.currentShape);
                    });
                });

                // 模态框事件
                this.closeModal.addEventListener('click', () => this.hideTrainingLog());
                this.clearLogBtn.addEventListener('click', () => this.clearTrainingLog());
                
                // 点击模态框外部关闭
                window.addEventListener('click', (e) => {
                    if (e.target === this.logModal) {
                        this.hideTrainingLog();
                    }
                });
            }

            setupMode() {
                this.colorSelector.style.display = 'none';
                this.shapeSelector.style.display = 'none';
                this.nextBtn.style.display = 'none';

                switch(this.currentMode) {
                    case 'yellow':
                        this.setupYellowCard();
                        break;
                    case 'color':
                        this.colorSelector.style.display = 'flex';
                        this.nextBtn.style.display = 'inline-block';
                        document.querySelector('.color-option').classList.add('active');
                        this.setupColorCard('red');
                        this.currentColorIndex = 0;
                        break;
                    case 'shape':
                        this.shapeSelector.style.display = 'flex';
                        this.setupShapeCard('circle');
                        break;
                }
                this.updateInstructions();
            }

            setupYellowCard() {
                this.trainingCard.className = 'training-card yellow-card';
                this.trainingCard.innerHTML = '';
            }

            setupColorCard(color) {
                this.trainingCard.className = `training-card color-${color}`;
                this.trainingCard.innerHTML = '';
            }

            setupShapeCard(shape) {
                this.trainingCard.className = 'training-card shape-card';
                let shapeElement = '';
                switch(shape) {
                    case 'circle':
                        shapeElement = '<div class="circle"></div>';
                        break;
                    case 'triangle':
                        shapeElement = '<div class="triangle"></div>';
                        break;
                    case 'diamond':
                        shapeElement = '<div class="diamond"></div>';
                        break;
                }
                this.trainingCard.innerHTML = shapeElement;
            }

            startTraining() {
                // 让训练卡片填满训练区域
                this.trainingCard.classList.add('training-active');
                
                if (!this.isTraining) {
                    // 第一次开始训练
                    this.isTraining = true;
                    this.autoTraining = true;
                    this.sessionStartTime = new Date();
                }
                
                this.totalTime = parseInt(this.durationInput.value, 10);
                this.timeLeft = this.totalTime;
                this.startBtn.disabled = true;
                this.switchBtn.disabled = false;
                this.stopBtn.disabled = false;
                
                this.updateTimer();
                this.timer = setInterval(() => {
                    this.timeLeft--;
                    this.updateTimer();
                    
                    if (this.timeLeft <= 0) {
                        this.completeTraining();
                    }
                }, 1000);
            }

            completeTraining() {
                clearInterval(this.timer);
                this.timerDisplay.textContent = '凝视完成！自动切换到白纸...';
                this.timerDisplay.style.color = '#48bb78';
                this.progressFill.style.width = '100%';
                
                // 1秒后自动切换到白纸
                setTimeout(() => {
                    if (this.isTraining) {
                        this.autoSwitchToWhite();
                    }
                }, 1000);
            }

            autoSwitchToWhite() {
                this.trainingCard.className = 'training-card white-background';
                this.trainingCard.innerHTML = '';
                this.timerDisplay.textContent = '观察白纸上的残像...';
                this.timerDisplay.style.color = '#667eea';
                this.switchBtn.disabled = true;
                
                // 开始白纸阶段的30秒计时
                this.timeLeft = this.totalTime;
                this.timer = setInterval(() => {
                    this.timeLeft--;
                    this.updateWhiteTimer();
                    
                    if (this.timeLeft <= 0) {
                        this.completeWhitePhase();
                    }
                }, 1000);
            }

            updateWhiteTimer() {
                const minutes = Math.floor(this.timeLeft / 60);
                const seconds = this.timeLeft % 60;
                this.timerDisplay.textContent = `观察残像中... ${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                const progress = ((this.totalTime - this.timeLeft) / this.totalTime) * 100;
                this.progressFill.style.width = `${progress}%`;
                
                // 最后10秒变色提醒
                if (this.timeLeft <= 10 && this.timeLeft > 0) {
                    this.timerDisplay.style.color = '#f56565';
                } else {
                    this.timerDisplay.style.color = '#667eea';
                }
            }

            completeWhitePhase() {
                clearInterval(this.timer);
                this.currentRound++;
                this.updateRoundDisplay();
                
                // 记录本轮训练
                this.recordTrainingRound();
                
                this.timerDisplay.textContent = `第${this.currentRound}轮完成！3秒后自动开始下一轮...`;
                this.timerDisplay.style.color = '#48bb78';
                this.progressFill.style.width = '100%';
                
                // 3秒后自动开始下一轮训练
                setTimeout(() => {
                    if (this.isTraining) {
                        this.autoStartNextRound();
                    }
                }, 3000);
            }

            autoStartNextRound() {
                // 自动开始下一轮训练
                this.timerDisplay.textContent = '自动开始下一轮训练...';
                this.progressFill.style.width = '0%';
                this.setupMode(); // 重新设置卡片
                
                setTimeout(() => {
                    if (this.isTraining) {
                        this.startTraining();
                    }
                }, 1000);
            }

            switchToWhite() {
                // 手动切换到白纸（保留原有功能）
                this.trainingCard.className = 'training-card white-background';
                this.trainingCard.innerHTML = '';
                this.timerDisplay.textContent = '观察白纸上的残像，尽量保持专注';
                this.timerDisplay.style.color = '#667eea';
                this.switchBtn.disabled = true;
                
                // 60秒后提示
                setTimeout(() => {
                    if (this.isTraining) {
                        this.timerDisplay.textContent = '很好！可以停止训练或继续下一轮';
                    }
                }, 60000);
            }

            stopTraining() {
                // 移除训练时的扩展样式
                this.trainingCard.classList.remove('training-active');

                // 停止训练并保存训练记录
                if (this.isTraining && this.sessionStartTime) {
                    this.saveTrainingSession();
                }
                
                this.resetTraining();
                this.setupMode();
            }

            resetTraining() {
                this.isTraining = false;
                this.autoTraining = false;
                
                // 移除训练时的扩展样式
                this.trainingCard.classList.remove('training-active');
                
                if (this.timer) {
                    clearInterval(this.timer);
                    this.timer = null;
                }
                
                // 重置轮次和会话时间
                this.currentRound = 0;
                this.sessionStartTime = null;
                this.sessionTime = 0;
                
                this.startBtn.disabled = false;
                this.switchBtn.disabled = true;
                this.stopBtn.disabled = true;
                
                this.timerDisplay.textContent = '准备开始训练';
                this.timerDisplay.style.color = '#4c51bf';
                this.progressFill.style.width = '0%';
                
                // 更新显示
                this.updateRoundDisplay();
                this.updateSessionTimeDisplay();
            }

            nextItem() {
                if (this.currentMode === 'color') {
                    this.currentColorIndex = (this.currentColorIndex + 1) % this.colors.length;
                    const nextColor = this.colors[this.currentColorIndex];
                    
                    // 更新颜色选择器
                    document.querySelectorAll('.color-option').forEach(o => o.classList.remove('active'));
                    document.querySelector(`[data-color="${nextColor}"]`).classList.add('active');
                    
                    this.setupColorCard(nextColor);
                    this.resetTraining();
                }
            }

            updateTimer() {
                const minutes = Math.floor(this.timeLeft / 60);
                const seconds = this.timeLeft % 60;
                this.timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                const progress = ((this.totalTime - this.timeLeft) / this.totalTime) * 100;
                this.progressFill.style.width = `${progress}%`;
                
                // 最后10秒变色提醒
                if (this.timeLeft <= 10 && this.timeLeft > 0) {
                    this.timerDisplay.style.color = '#f56565';
                } else {
                    this.timerDisplay.style.color = '#4c51bf';
                }
            }

            updateInstructions() {
                const instructions = {
                    'yellow': {
                        title: '🎯 黄卡训练说明',
                        steps: [
                            '1. 在上方设置好每阶段时长后，点击"开始训练"按钮',
                            '2. 每轮训练：凝视黄卡【设定时长】 → 自动切换白纸【设定时长】 → 自动开始下一轮',
                            '3. 训练过程中尽量不要眨眼，保持注意力集中',
                            '4. 初期看到的残像是补色（蓝底黄点），随着训练进步会看到原色',
                            '5. 程序会自动记录训练时间和轮次，可点击"停止训练"结束并保存记录'
                        ]
                    },
                    'color': {
                        title: '🌈 彩虹颜色训练说明',
                        steps: [
                            '1. 设置时长，选择颜色后点击"开始训练"，程序自动连续训练',
                            '2. 每轮：凝视彩色圆形【设定时长】 → 自动切换白纸观察残像【设定时长】',
                            '3. 训练会自动循环进行，注意观察残像的补色效果',
                            '4. 可随时点击"下一个"切换到其他颜色继续训练',
                            '5. 目标是能看到原本的颜色而非补色'
                        ]
                    },
                    'shape': {
                        title: '📐 形状训练说明',
                        steps: [
                            '1. 设置时长，选择形状后点击"开始训练"，程序将自动连续进行',
                            '2. 每轮：凝视形状【设定时长】 → 自动切换白纸观察残像【设定时长】',
                            '3. 专注于黑色轮廓边缘，观察线条变白、图形浮起的效果',
                            '4. 训练会自动循环，可随时切换不同形状',
                            '5. 熟练后建议用生活中的具体物品练习'
                        ]
                    }
                };

                const current = instructions[this.currentMode];
                this.instructions.innerHTML = `
                    <h3>${current.title}</h3>
                    <ul>
                        ${current.steps.map(step => `<li>${step}</li>`).join('')}
                    </ul>
                `;
            }

            loadTrainingStats() {
                this.updateTotalTimeDisplay();
            }

            startSessionTimer() {
                // 每秒更新会话时间显示
                this.sessionTimer = setInterval(() => {
                    if (this.isTraining && this.sessionStartTime) {
                        const now = new Date();
                        this.sessionTime = Math.floor((now - this.sessionStartTime) / 1000);
                        this.updateSessionTimeDisplay();
                    }
                }, 1000);
            }

            updateRoundDisplay() {
                this.currentRoundDisplay.textContent = this.currentRound;
            }

            updateSessionTimeDisplay() {
                const minutes = Math.floor(this.sessionTime / 60);
                const seconds = this.sessionTime % 60;
                this.sessionTimeDisplay.textContent = `${minutes}分${seconds}秒`;
            }

            updateTotalTimeDisplay() {
                const totalSeconds = parseInt(localStorage.getItem('totalTrainingTime') || '0');
                const totalMinutes = Math.floor(totalSeconds / 60);
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                
                if (hours > 0) {
                    this.totalTimeDisplay.textContent = `${hours}小时${minutes}分钟`;
                } else {
                    this.totalTimeDisplay.textContent = `${totalMinutes}分钟`;
                }
            }

            showTrainingLog() {
                const trainingHistory = JSON.parse(localStorage.getItem('trainingHistory') || '[]');
                
                if (trainingHistory.length === 0) {
                    this.logContent.innerHTML = '<p style="text-align: center; color: #718096;">暂无训练记录</p>';
                } else {
                    let logHtml = '';
                    trainingHistory.forEach(session => {
                        const duration = this.formatDuration(session.duration);
                        logHtml += `
                            <div class="log-entry">
                                <div class="log-date">${session.date} ${session.startTime} - ${session.endTime}</div>
                                <div class="log-details">
                                    训练模式: ${session.modeText} | 
                                    完成轮次: ${session.rounds}轮 | 
                                    训练时长: ${duration}
                                </div>
                            </div>
                        `;
                    });
                    this.logContent.innerHTML = logHtml;
                }
                
                this.logModal.style.display = 'block';
            }

            hideTrainingLog() {
                this.logModal.style.display = 'none';
            }

            clearTrainingLog() {
                if (confirm('确定要清空所有训练记录吗？此操作不可恢复。')) {
                    localStorage.removeItem('trainingHistory');
                    localStorage.removeItem('totalTrainingTime');
                    this.updateTotalTimeDisplay();
                    this.showTrainingLog(); // 刷新显示
                }
            }

            formatDuration(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                
                if (hours > 0) {
                    return `${hours}小时${minutes}分${secs}秒`;
                } else if (minutes > 0) {
                    return `${minutes}分${secs}秒`;
                } else {
                    return `${secs}秒`;
                }
            }

            recordTrainingRound() {
                // 记录单轮训练数据（内部使用，不保存到localStorage）
                const roundData = {
                    round: this.currentRound,
                    mode: this.currentMode,
                    timestamp: new Date().toISOString()
                };
                // 这里可以添加更多轮次统计逻辑
            }

            saveTrainingSession() {
                if (!this.sessionStartTime) return;
                
                const sessionEnd = new Date();
                const sessionDuration = Math.floor((sessionEnd - this.sessionStartTime) / 1000); // 秒
                
                const sessionData = {
                    date: this.sessionStartTime.toISOString().split('T')[0],
                    startTime: this.sessionStartTime.toLocaleTimeString(),
                    endTime: sessionEnd.toLocaleTimeString(),
                    duration: sessionDuration,
                    rounds: this.currentRound,
                    mode: this.currentMode,
                    modeText: this.getModeText()
                };
                
                // 保存到localStorage
                let trainingHistory = JSON.parse(localStorage.getItem('trainingHistory') || '[]');
                trainingHistory.unshift(sessionData); // 最新的记录放在前面
                
                // 只保留最近100条记录
                if (trainingHistory.length > 100) {
                    trainingHistory = trainingHistory.slice(0, 100);
                }
                
                localStorage.setItem('trainingHistory', JSON.stringify(trainingHistory));
                
                // 更新累计时间
                let totalTrainingTime = parseInt(localStorage.getItem('totalTrainingTime') || '0');
                totalTrainingTime += sessionDuration;
                localStorage.setItem('totalTrainingTime', totalTrainingTime.toString());
                
                this.updateTotalTimeDisplay();
            }

            getModeText() {
                const modeTexts = {
                    'yellow': '黄卡训练',
                    'color': '彩虹颜色训练',
                    'shape': '形状训练'
                };
                return modeTexts[this.currentMode] || '未知训练';
            }
        }

        class PomodoroClock {
            constructor() {
                this.focusTime = 25 * 60; // 25 minutes
                this.breakTime = 5 * 60; // 5 minutes
                this.currentTime = this.focusTime;
                this.isPaused = true;
                this.isFocusMode = true;
                this.timerInterval = null;

                this.timeDisplay = document.getElementById('pomodoroTime');
                this.statusDisplay = document.getElementById('pomodoroStatus');
                this.startPauseBtn = document.getElementById('pomodoroStartPause');
                this.resetBtn = document.getElementById('pomodoroReset');

                this.bindEvents();
                this.updateDisplay();
            }

            bindEvents() {
                this.startPauseBtn.addEventListener('click', () => this.toggleTimer());
                this.resetBtn.addEventListener('click', () => this.resetTimer());
            }

            toggleTimer() {
                this.isPaused = !this.isPaused;
                if (this.isPaused) {
                    clearInterval(this.timerInterval);
                    this.startPauseBtn.textContent = '继续';
                } else {
                    this.startPauseBtn.textContent = '暂停';
                    this.timerInterval = setInterval(() => this.tick(), 1000);
                }
            }

            tick() {
                if (this.currentTime > 0) {
                    this.currentTime--;
                    this.updateDisplay();
                } else {
                    this.switchMode();
                }
            }

            switchMode() {
                clearInterval(this.timerInterval);
                this.isPaused = true;
                this.isFocusMode = !this.isFocusMode;

                if (this.isFocusMode) {
                    alert('休息结束！准备开始下一个专注时段。');
                    this.currentTime = this.focusTime;
                    this.statusDisplay.textContent = '专注';
                    this.statusDisplay.classList.remove('break-mode');
                } else {
                    alert('专注时段结束！休息一下吧。');
                    this.currentTime = this.breakTime;
                    this.statusDisplay.textContent = '休息';
                    this.statusDisplay.classList.add('break-mode');
                }
                
                this.startPauseBtn.textContent = '开始';
                this.updateDisplay();
            }

            resetTimer() {
                clearInterval(this.timerInterval);
                this.isPaused = true;
                this.isFocusMode = true;
                this.currentTime = this.focusTime;
                this.updateDisplay();
                this.startPauseBtn.textContent = '开始';
                this.statusDisplay.textContent = '专注';
                this.statusDisplay.classList.remove('break-mode');
            }

            updateDisplay() {
                const minutes = Math.floor(this.currentTime / 60);
                const seconds = this.currentTime % 60;
                this.timeDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // 初始化训练器
        document.addEventListener('DOMContentLoaded', () => {
            new AfterimageTrainer();
            new PomodoroClock();
        });
    </script>
</body>
</html> 